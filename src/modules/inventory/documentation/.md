
# OAS API Documentation

**Base URL:** `{{baseURL}}`

This document describes the endpoints available in the OAS API for user authentication and inventory management, including products, tags, categories, suppliers, inventory points, and purchases.

---

## User Authentication

### 1. Get CSRF Token

- **Method:** `GET`
- **Endpoint:** `/api/auth/csrf`
- **Description:** Retrieves a CSRF token for secure authentication.
- **Success Response:**
```json
{
  "csrfToken": "<token>"
}
```

---

### 2. Login with Credentials

- **Method:** `POST`
- **Endpoint:** `/api/auth/callback/credentials`
- **Description:** Authenticates a user using email and password with a CSRF token.
- **Headers:**
  - `Cookie: next-auth.csrf-token=<token>`
- **Request Body:**
```json
{
  "email": "your-email@example.com",
  "password": "your-password",
  "csrfToken": "<token>"
}
```
- **Response:** HTML or redirect response with session cookies.

---

## Inventory Management

### Products

#### 1. Get All Products

- **Method:** `GET`
- **Endpoint:** `/api/inventory/product`
- **Description:** Returns a list of all products.

#### 2. Add New Product

- **Method:** `POST`
- **Endpoint:** `/api/inventory/product`
- **Request Body:**
```json
{
  "product_name": "Keyboard Compact",
  "product_barcode": 1666686,
  "product_description": "Slim wireless keyboard",
  "product_location": "Store Room C - Shelf 5",
  "unit_id": 2,
  "category_id": 1,
  "tag_id": 4,
  "buying_price": 38000,
  "selling_price": 52000,
  "currency_id": 1,
  "product_status": 1,
  "supplier_id": 5,
  "inventory_point_id": 3
}
```

#### 3. Update Product

- **Method:** `PATCH`
- **Endpoint:** `/api/inventory/product/{id}`
- **Request Body:**
```json
{
  "buying_price": 25000,
  "selling_price": 76000
}
```

#### 4. Delete Product

- **Method:** `DELETE`
- **Endpoint:** `/api/inventory/product/{id}`

---

### Tags

#### 1. Create Tag

- **Method:** `POST`
- **Endpoint:** `/api/inventory/tag`
- **Request Body:**
```json
{
  "tag": "Mouse"
}
```

#### 2. Get All Tags

- **Method:** `GET`
- **Endpoint:** `/api/inventory/tag`

#### 3. Update Tag

- **Method:** `PATCH`
- **Endpoint:** `/api/inventory/tag/{id}`
- **Request Body:**
```json
{
  "tag": "Laptops"
}
```

#### 4. Delete Tag

- **Method:** `DELETE`
- **Endpoint:** `/api/inventory/tag/{id}`

---

### Categories

#### 1. Create Category

- **Method:** `POST`
- **Endpoint:** `/api/inventory/category`
- **Request Body:**
```json
{
  "category": "Music"
}
```

#### 2. Get All Categories

- **Method:** `GET`
- **Endpoint:** `/api/inventory/category`

#### 3. Update Category

- **Method:** `PATCH`
- **Endpoint:** `/api/inventory/category/{id}`
- **Request Body:**
```json
{
  "category": "Maths"
}
```

#### 4. Delete Category

- **Method:** `DELETE`
- **Endpoint:** `/api/inventory/category/{id}`

---

### Suppliers

#### 1. Create Supplier

- **Method:** `POST`
- **Endpoint:** `/api/inventory/supplier`
- **Request Body:**
```json
{
  "supplier_name": "SolarBright Africa Ltd",
  "supplier_email": "info@solarbright.africa",
  "supplier_phone": "+256709998877",
  "supplier_address": "Entebbe Road, Opp. Freedom City",
  "supplier_tinNumber": 334455667
}
```

#### 2. Get All Suppliers

- **Method:** `GET`
- **Endpoint:** `/api/inventory/supplier`

#### 3. Update Supplier

- **Method:** `PATCH`
- **Endpoint:** `/api/inventory/supplier/{id}`
- **Request Body:**
```json
{
  "supplier_tinNumber": 1053636782378
}
```

#### 4. Delete Supplier

- **Method:** `DELETE`
- **Endpoint:** `/api/inventory/supplier/{id}`

---

### Inventory Points

#### 1. Create Inventory Point

- **Method:** `POST`
- **Endpoint:** `/api/inventory/inventory_point`
- **Request Body:**
```json
{
  "inventory_point": "Akamwesi"
}
```

#### 2. Get All Inventory Points

- **Method:** `GET`
- **Endpoint:** `/api/inventory/inventory_point`

#### 3. Update Inventory Point

- **Method:** `PATCH`
- **Endpoint:** `/api/inventory/inventory_point/{id}`
- **Request Body:**
```json
{
  "inventory_point": "Show Room"
}
```

#### 4. Delete Inventory Point

- **Method:** `DELETE`
- **Endpoint:** `/api/inventory/inventory_point/{id}`

---

### Purchases

#### 1. Create Purchase

- **Method:** `POST`
- **Endpoint:** `/api/inventory/purchase`
- **Request Body:**
```json
{
  "inventory_point_id": 1,
  "supplier_id": 5,
  "purchase_items": [
    {
      "product_id": 16,
      "quantity": 5,
      "unit_cost": 1400,
      "total_cost": 7000
    }
  ]
}
```

---

# Inventory API Reference (Detailed)

This section documents all Inventory module endpoints implemented under `src/app/api/inventory/`, with request/response formats, validation rules, and auth requirements derived from the code.

## Conventions

- **Auth/session**: Many endpoints validate a NextAuth session using `SessionService.checkIsUserSessionOk()`.
- **Errors**: Validation errors often return `{ message | error, details? }` with HTTP 400. Server failures return 500 with `{ error | message }`.
- **IDs**: Numeric IDs such as `product_id`, `inventory_point_id` are integers.

## Products

- File: `src/app/api/inventory/product/route.ts`
- File: `src/app/api/inventory/product/[id]/route.ts`

1) GET `/api/inventory/product`
- Returns: list of products.
- Auth: not enforced in code.

2) POST `/api/inventory/product`
- Auth: requires valid session. Injects `created_by` from session.
- Body (validated by `CreateProductDto`):
  - product_name, product_barcode, product_description, unit_id, category_id, tag_id, currency_id, supplier_id?, product_status?, buying_price, selling_price, product_min_quantity?, product_max_quantity?
- Response: 201 with created product; 400 on validation errors.

3) PATCH `/api/inventory/product/{id}`
- Auth: required. Injects `updated_by`.
- Body: fields allowed by `UpdateProductDto`.
- Responses: 200 with `{ message, updated }` or 404 if not found, 400 on validation.

4) DELETE `/api/inventory/product/{id}`
- Auth: required.
- Response: `{ message }` on success; 404 if not found.

5) GET `/api/inventory/product/available?inventory_point_id=number&q=term`
- File: `product/available/route.ts`
- Query:
  - inventory_point_id: required, number
  - q: optional string; matches `product_name` contains or exact numeric barcode
- Response: `{ items: [{ product_id, product_name, product_barcode, unit_id, product_status, available_quantity, inventory_point_id }], count }`

## Tags

- File: `tag/route.ts`

1) GET `/api/inventory/tag`
- Auth: session required.
- Returns: list of tags.

2) POST `/api/inventory/tag`
- Auth: required; injects `created_by`.
- Body: `{ tag: string }`
- Responses: 200 `{ message, data }` or 400 on validation/conflict.

## Categories

- File: `category/route.ts`

1) GET `/api/inventory/category`
- Returns: list of categories.

2) POST `/api/inventory/category`
- Auth: required; injects `created_by`.
- Body: `{ category: string }`
- Responses: 200 `{ message, data }` or 400 on validation.

## Suppliers

- File: `supplier/route.ts`

1) GET `/api/inventory/supplier`
- Auth: session required.
- Returns: list of suppliers.

2) POST `/api/inventory/supplier`
- Auth: required; injects `created_by`.
- Body: fields per `SupplierDto` such as `supplier_name`, `supplier_email?`, `supplier_phone?`, `supplier_address?`, `supplier_tinNumber?`.
- Responses: 200 `{ message, data }` or 400/500.

## Units

- File: `unit/route.ts`

1) GET `/api/inventory/unit`
- Auth: session required.
- Returns: list of units.

2) POST `/api/inventory/unit`
- Auth: required.
- Body: `UnitDto` fields: `{ name: string, short_name?, unit_desc? }`.
- Response: 200 `{ message, data }` or 400 on validation.

## Currencies

- File: `currency/route.ts`

1) GET `/api/inventory/currency`
- Returns: list of currencies.

2) POST `/api/inventory/currency`
- Body: `{ currency_code, currency_name }`
- Response: created currency record.

## Inventory Points

- File: `inventory_point/route.ts`, `inventory_point/[id]/route.ts`

1) GET `/api/inventory/inventory_point`
- Auth: session required.
- Returns: list of inventory points.

2) POST `/api/inventory/inventory_point`
- Auth: required; injects `created_by`.
- Body: `{ inventory_point: string }`
- Responses: 201 `{ message, data }` or 400.

3) PATCH `/api/inventory/inventory_point/{id}`
- Auth: required; injects `updated_by`.
- Body validated by `Inventory_pointDto`.
- Response: 200 `{ updated, message }`.

4) DELETE `/api/inventory/inventory_point/{id}`
- Auth: required.
- Response: 200 `{ message }`.

## Purchases

- File: `purchase/route.ts`, `purchase_items/route.ts`

1) GET `/api/inventory/purchase`
- Returns: list of purchases.

2) POST `/api/inventory/purchase`
- Auth: required; injects `purchase_created_by`.
- Body: `PurchaseDto` including `inventory_point_id`, `supplier_id`, and `purchase_items` array of `{ product_id, quantity, unit_cost, total_cost }`.
- Response: 201 `{ message, data }`.

3) GET `/api/inventory/purchase_items`
- Returns: list of purchase items.

## Stock and Inventory Stock

- Files: `stock/route.ts`, `stock/adjust/route.ts`, `stock/availability/route.ts`, `inventory_stock/route.ts`

1) GET `/api/inventory/stock`
- Returns: all stock entries.

2) POST `/api/inventory/stock`
- Body: `StockDto` minus `resulting_stock` (derived). Fields include `product_id`, `inventory_point_id`, `change_type`, `quantity_change`, etc.
- Response: 201 created stock entry after applying via service.

3) PATCH `/api/inventory/stock/adjust`
- Body: same validation as stock POST. Allows negative `quantity_change` to reduce stock.
- Response: updated/created stock entry.

4) GET `/api/inventory/stock/availability?product_id=number&inventory_point_id=number`
- Response: `{ product_id, inventory_point_id, quantity }` available at point.

5) GET `/api/inventory/inventory_stock`
- Returns: current inventory stock list across products/points.

## Transfers

- File: `transfer/route.ts`

1) GET `/api/inventory/transfer`
- Returns: list of transfers.

2) POST `/api/inventory/transfer`
- Body: `TransferDto` including `from_inventory_point_id`, `to_inventory_point_id`, and items.
- Behavior: applies stock movements via `StockService`.
- Response: 201 with created transfer.

## Orders

- Files: `order/route.ts`, `order/[id]/route.ts`

1) GET `/api/inventory/order`
- Auth: session required.
- Returns: list of orders.

2) POST `/api/inventory/order`
- Auth: required; injects `created_by`.
- Body: `OrderDto` including `supplier_id`, `items` (array of `{ product_id, quantity, unit_price, total_price }`), etc.
- Response: `{ message, data }`.

3) PATCH `/api/inventory/order/{id}`
- Auth: required; injects `updated_by`.
- Body: partial update fields.
- Response: `{ updated, message }`.

4) DELETE `/api/inventory/order/{id}`
- Auth: required.
- Behavior: deletes `order_item` rows then the order.
- Response: `{ message }`.

## Sales

- File: `sale/route.ts`

1) GET `/api/inventory/sale`
- Returns: list of sales.

2) POST `/api/inventory/sale`
- Auth: required.
- Body: `SaleDto` including `inventory_point_id`, `currency_id`, `items` etc. If `seller_co_user_id` missing, it is injected from session.
- Special errors: if insufficient stock, returns 400 with `{ message, inventory_point_id, items }` and code handled as `INSUFFICIENT_STOCK` in service layer.

## Analytics

- Files: `analytics/summary/route.ts`, `analytics/sales-trend/route.ts`

1) GET `/api/inventory/analytics/summary?from=YYYY-MM-DD&to=YYYY-MM-DD&inventory_point_id=number`
- Computes: `valuation`, `low_stock_count`, `out_of_stock_rate`, `sales_period_amount`.
- Defaults: last 30 days when not provided.

2) GET `/api/inventory/analytics/sales-trend?from=YYYY-MM-DD&to=YYYY-MM-DD&groupBy=day|week|month&inventory_point_id=number`
- Returns time-bucketed rows: `{ period, total_amount, transactions }`.
- Defaults: last 30 days; `groupBy=day`.

## Alerts

- File: `alerts/route.ts`

1) GET `/api/inventory/alerts?inventory_point_id=number&type=low_stock,stockout,overstock`
- Builds alerts from `inventory_stock` joined with product min/max and inventory points.
- Returns: `{ count, alerts: [{ type, product_id, product_name, inventory_point_id, inventory_point, quantity, min?, max?, message }] }`.

---

## Authentication Notes

- Endpoints explicitly checking session in code include: `product POST`, `product [id] PATCH/DELETE`, `tag GET/POST`, `category POST`, `supplier GET/POST`, `unit GET/POST`, `inventory_point GET/POST/[id]`, `purchase POST`, `order GET/POST/[id]`, `sale POST`.
- Others (e.g., `currency`, some `stock` reads) do not enforce auth in code; apply gateway/middleware if required.

## Error Handling Examples

- Validation failure (Zod):
```json
{
  "error": "Invalid input",
  "details": { /* zod formatted errors */ }
}
```

- Unauthorized:
```json
{ "error": "Unauthorized" }
```

- Generic server error:
```json
{ "error": "Internal Server Error" }
```

